/*!
 * @oktarintentakel/annex v0.1.19-beta
 */
/*!
 * Module Events
 */
const MODULE_NAME="Events";import{assert,isFunction,isString,isArray,isBoolean,isObject,isWindow,isEventTarget,isPlainObject,isElement,orDefault,hasValue,isEmpty,isSelector}from"./basic.js";import{slugify,replace}from"./strings.js";import{removeFrom}from"./arrays.js";import{detectInteractionType}from"./context.js";import{warn}from"./logging.js";export const EVENT_MAP=new Map,POST_MESSAGE_MAP=new Map;const DEFAULT_NAMESPACE="__default",SWIPE_DIRECTIONS=["up","right","down","left"],SWIPE_HANDLERS=new WeakMap,SWIPE_TOUCH={startX:0,startY:0,endX:0,endY:0},EVENT_OPTION_SUPPORT={capture:!1,once:!1,passive:!1,signal:!1};try{const e={get capture(){return EVENT_OPTION_SUPPORT.capture=!0,!1},get once(){return EVENT_OPTION_SUPPORT.once=!0,!1},get passive(){return EVENT_OPTION_SUPPORT.passive=!0,!1},get signal(){return EVENT_OPTION_SUPPORT.signal=!0,!1}};window.addEventListener("test",null,e),window.removeEventListener("test",null,e)}catch(t){}function prepareEventMethodBaseParams(e,t,n,a,r=!1){t=orDefault(t,[],"arr"),assert(t.length>0,`${MODULE_NAME}:${e} | no targets provided`),n=orDefault(n,[],"arr"),assert(n.length>0,`${MODULE_NAME}:${e} | no events provided`),r&&!hasValue(a)||assert(isFunction(a),`${MODULE_NAME}:${e} | handler is not a function`);let s=!0,o=!0;t.forEach(((e,n)=>{if(isString(e)){const a=n>0?t[n-1]:null;o&&=isSelector(e)&&isEventTarget(a)}else s&&=isEventTarget(e)})),assert(s,`${MODULE_NAME}:${e} | not all targets are event targets`),assert(o,`${MODULE_NAME}:${e} | not all delegated targets are a selector or have an ancestor`);const l=n.map((e=>e.replace(`.${DEFAULT_NAMESPACE}`,".-default-ns"))).map((e=>replace(e,["xxyxxx-","-xxyxx"],""))).map((e=>slugify(e,{_:"xxyxx-underscore-xxyxx",".":"xxyxx-dot-xxyxx","*":"xxyxx-star-xxyxx",":":"xxyxx-colon-xxyxx"}))).map((e=>replace(e,["xxyxx-underscore-xxyxx","xxyxx-dot-xxyxx","xxyxx-star-xxyxx","xxyxx-colon-xxyxx"],["_",".","*",":"]))).map((e=>e.replace(".-default-ns",`.${DEFAULT_NAMESPACE}`)));for(const t in l)l[t]!==n[t]&&warn(`${MODULE_NAME}:${e} | invalid event name "${n[t]}" has been normalized to "${l[t]}", please check event handling`);return{targets:t,events:n=l,handler:a}}function prepareEventMethodAdditionalTargetInfo(e,t,n){const a=n-1>=0?t[n-1]:null,r=n<t.length-1?t[n+1]:null,s=isSelector(r),o=isSelector(t[n]);return assert(!o||o&&isEventTarget(a),`${MODULE_NAME}:${e} | delegation has no ancestor`),{prevTarget:a,nextTarget:r,hasDelegation:s,isDelegation:o}}function prepareEventMethodEventInfo(e,t=null,n=null){const a=e.replace(".","/////").split("/////");return{event:isEmpty(a[0])||"*"===a[0]?n:a[0],namespace:isEmpty(a[1])||"*"===a[1]?t:a[1]}}function gatherTargetEvents(e,t=null,n=null,a=null){const r=EVENT_MAP.get(e);assert(isPlainObject(r),`${MODULE_NAME}:gatherTargetEvents | invalid target "${e}"`);const s={};if(hasValue(t)||hasValue(n))if(hasValue(n))if(hasValue(t)){const e=r[t];hasValue(e)&&hasValue(e[n])&&(!hasValue(a)||hasValue(e[n].delegations[a]))&&(hasValue(s[t])||(s[t]=new Set([])),s[t].add(n))}else Object.keys(r).forEach((e=>{const t=r[e];!hasValue(t[n])||hasValue(a)&&!hasValue(t[n].delegations[a])||(hasValue(s[e])||(s[e]=new Set([])),s[e].add(n))}));else{const e=r[t];hasValue(e)&&(s[t]=new Set([]),Object.keys(r[t]).forEach((n=>{hasValue(a)&&!hasValue(e[n].delegations[a])||s[t].add(n)})))}else Object.keys(r).forEach((e=>{s[e]=new Set([]),Object.keys(r[e]).forEach((t=>{hasValue(a)&&!hasValue(r[e][t].delegations[a])||s[e].add(t)}))}));return s}function cleanUpEventMap(e){e=hasValue(e)?new Set([].concat(e)):null;const t=[];EVENT_MAP.forEach(((n,a)=>{hasValue(e)&&!e.has(a)||(Object.keys(n).forEach((e=>{Object.keys(n[e]).forEach((t=>{const a=n[e][t];let r=a.handlers.length;Object.keys(a.delegations).forEach((e=>{const t=a.delegations[e].handlers.length;r+=t,0===t&&delete a.delegations[e]})),0===r&&delete n[e][t]})),0===Object.keys(n[e]).length&&delete n[e]})),0===Object.keys(n).length&&t.push(a))})),t.forEach((e=>{EVENT_MAP.delete(e)}))}function createDelegatedHandler(e,t){return function(n){const a=`${e}`;(hasValue(n.target?.matches)?n.target.matches(a):isEventTarget(n.syntheticTarget)||isArray(n.syntheticTarget)&&isSelector(n.syntheticTarget[1])?isEventTarget(n.syntheticTarget)?n.syntheticTarget.matches(a):n.syntheticTarget[1]===a:null)&&t(n)}}function createHandlerRemover(e,t,n,a,r=null,s=!1){const o="createHandlerRemover",l=EVENT_MAP.get(e);let c=l?.[t]?.[n];if(hasValue(r)&&(assert(isSelector(r),`${MODULE_NAME}:${o} | invalid delegation "${r}"`),c=c.delegations[`${r}`]),s){if(!isPlainObject(c))return()=>{}}else assert(isPlainObject(c),`${MODULE_NAME}:${o} | invalid handlerScope`);return function(){const t=c.handlers.filter((e=>e.handler===a));c.handlers=removeFrom(c.handlers,t),t.forEach((t=>{e.removeEventListener(n,t.action)})),cleanUpEventMap(e)}}function createSelfRemovingHandler(e,t,n,a,r=null){return function(s){a(s),createHandlerRemover(e,t,n,a,r,!0)()}}function removeLocatedHandler(e,t,n,a,r=null){const s="removeLocatedHandler",o=EVENT_MAP.get(e),l=o?.[t]?.[n];let c;if(assert(isPlainObject(l),`${MODULE_NAME}:${s} | invalid targetScope`),hasValue(r)){const e=l.delegations[`${r}`];assert(isPlainObject(e),`${MODULE_NAME}:${s} | invalid delegation "${r}"`),c=e}else c=l;const i=c.handlers.filter((e=>!hasValue(a)||a===e.handler));return c.handlers=removeFrom(c.handlers,i),i.forEach((t=>{e.removeEventListener(n,t.action),e.removeEventListener(n,t.action,{capture:!0})})),i.length}function removeHandlers(e,t=null,n=null,a=null,r=null){const s=gatherTargetEvents(e,t,n,r);let o=0;return Object.keys(s).forEach((t=>{Array.from(s[t]).forEach((n=>{o+=removeLocatedHandler(e,t,n,a,r)}))})),o}function removeDelegatedHandlers(e,t,n=null,a=null,r=null){return removeHandlers(e,n,a,r,t)}function pauseLocatedHandlers(e,t,n,a,r=null,s=!0){const o="pauseLocatedHandlers",l=EVENT_MAP.get(e),c=l?.[t]?.[n];let i;if(assert(isPlainObject(c),`${MODULE_NAME}:${o} | invalid targetScope`),hasValue(r)){const e=c.delegations[`${r}`];assert(isPlainObject(e),`${MODULE_NAME}:${o} | invalid delegation "${r}"`),i=e}else i=c;const u=i.handlers.filter((e=>!hasValue(a)||a===e.handler));return u.forEach((e=>{e.paused=!!s})),u.length}function pauseHandlers(e,t=null,n=null,a=null,r=null,s=!0){const o=gatherTargetEvents(e,t,n,r);let l=0;return Object.keys(o).forEach((t=>{Array.from(o[t]).forEach((n=>{l+=pauseLocatedHandlers(e,t,n,a,r,s)}))})),l}function pauseDelegatedHandlers(e,t,n=null,a=null,r=null,s=!0){return pauseHandlers(e,n,a,r,t,s)}function createPauseAwareAction(e,t){return function(n){e.paused||t(n)}}function compileEventListenerOptions(e){if(isBoolean(e))return e;if(!isObject(e))return null;const t={};return Object.keys(EVENT_OPTION_SUPPORT).forEach((n=>{EVENT_OPTION_SUPPORT[n]&&hasValue(e[n])&&(t[n]=e[n])})),!(0!==Object.keys(t).length||!e.capture)||t}function createSyntheticEvent(e,t=null,n=null,a=null,r=null,s=null,o=null,l=null){let c;return e=`${e}`,a=orDefault(a,!1,"bool"),r=orDefault(r,a,"bool"),l=isPlainObject(l)?l:{},isFunction(o)?(hasValue(n)&&warn(`${MODULE_NAME}:createSyntheticEvent | can't add payload to event "${o.name}", skipping`),c=new o(e,{bubbles:a,cancelable:r,...l})):c=hasValue(n)?new CustomEvent(e,{detail:n,bubbles:a,cancelable:r,...l}):new CustomEvent(e,{bubbles:a,cancelable:r,...l}),hasValue(t)&&(c.namespace=`${t}`),isEventTarget(s)?(c.syntheticTarget=s,c.syntheticTargetElements=[s]):isArray(s)&&isEventTarget(s[0])&&isSelector(s[1])&&(c.syntheticTarget=s,Object.defineProperty(c,"syntheticTargetElements",{get:()=>Array.from(s[0].querySelectorAll(`${s[1]}`))})),c}function updateSwipeTouch(e){const t=["touchstart","mousedown"].includes(e.type)?"start":"end";["touchstart","touchend"].includes(e.type)?(SWIPE_TOUCH[`${t}X`]=e.changedTouches[0].screenX,SWIPE_TOUCH[`${t}Y`]=e.changedTouches[0].screenY):(SWIPE_TOUCH[`${t}X`]=e.screenX,SWIPE_TOUCH[`${t}Y`]=e.screenY)}function resolvePostMessageTarget(e,t){return e=isWindow(e)?e:isWindow(e?.contentWindow)?e.contentWindow:null,assert(hasValue(e),`${MODULE_NAME}:${t} | no usable target`),e}function windowPostMessageHandler(e){const t=e.currentTarget,n=POST_MESSAGE_MAP.get(t),a=isEmpty(e.origin)?window.__AVA_ENV__?window.location.href:null:e.origin,r=e.data?.type;if(hasValue(n)){(hasValue(r)?[r]:Object.keys(n)).forEach((t=>{(n[t]??[]).forEach((t=>{"*"!==t.origin&&t.origin!==a||t.handler(e)}))}))}}function removePostMessageHandlers(e,t,n=null,a=null){if(hasValue(e[t])){const r=e[t].length;hasValue(n)||hasValue(a)?hasValue(n)&&!hasValue(a)?e[t]=e[t].filter((e=>e.origin!==n)):!hasValue(n)&&hasValue(a)?e[t]=e[t].filter((e=>e.handler!==a)):hasValue(n,a)&&(e[t]=e[t].filter((e=>e.origin!==n&&e.handler!==a))):e[t]=[];const s=e[t].length;return 0===e[t].length&&delete e[t],r-s}return 0}export function on(e,t,n,a=null,r=!1){({targets:e,events:t,handler:n}=prepareEventMethodBaseParams("on",e,t,n)),r=!!r||!!a?.once,delete a?.once;const s=[];return e.forEach(((o,l)=>{const{prevTarget:c,hasDelegation:i,isDelegation:u}=prepareEventMethodAdditionalTargetInfo("on",e,l);let E=EVENT_MAP.get(o);u?E=EVENT_MAP.get(c):hasValue(E)||(EVENT_MAP.set(o,{[DEFAULT_NAMESPACE]:{}}),E=EVENT_MAP.get(o)),i||t.forEach((e=>{const{event:t,namespace:l}=prepareEventMethodEventInfo(e,DEFAULT_NAMESPACE);hasValue(E[l])||(E[l]={}),hasValue(E[l][t])||(E[l][t]={target:u?c:o,handlers:[],delegations:{}});const i=E[l][t];let d,h,g;u?(hasValue(i.delegations[o])||(i.delegations[o]={handlers:[]}),d=i.delegations[o],h=createDelegatedHandler(o,r?createSelfRemovingHandler(i.target,l,t,n,o):n),g=createHandlerRemover(i.target,l,t,n,o)):(d=i,h=r?createSelfRemovingHandler(i.target,l,t,n):n,g=createHandlerRemover(i.target,l,t,n));const f={handler:n,remover:g,paused:!1};f.action=createPauseAwareAction(f,h),d.handlers=d.handlers.concat(f);const p=compileEventListenerOptions(a);hasValue(p)?i.target.addEventListener(t,f.action,p):i.target.addEventListener(t,f.action),s.push(g)}))})),s.length>1?function(){s.forEach((e=>e()))}:s.length>0?s[0]:null}export function once(e,t,n,a=null){return on(e,t,n,a,!0)}export function off(e,t,n=null,a=!0){const r="off";({targets:e,events:t,handler:n}=prepareEventMethodBaseParams(r,e,t,n,!0)),a=orDefault(a,!0,"bool");let s=0;return e.forEach(((o,l)=>{const{prevTarget:c,hasDelegation:i,isDelegation:u}=prepareEventMethodAdditionalTargetInfo(r,e,l);if(!i){const e=u?EVENT_MAP.get(c):EVENT_MAP.get(o);t.forEach((t=>{const{event:l,namespace:i}=prepareEventMethodEventInfo(t);hasValue(e)?(s+=u?removeDelegatedHandlers(c,o,i,l,n):removeHandlers(o,i,l,n),cleanUpEventMap(u?c:o)):a&&(hasValue(n)?((u?c:o).removeEventListener(t,n),(u?c:o).removeEventListener(t,n,{capture:!0})):warn(`${MODULE_NAME}:${r} | native fallback event removal for "${t}" not possible, handler is missing`))}))}})),s}export function pause(e,t,n=null,a=!0){const r="pause";({targets:e,events:t,handler:n}=prepareEventMethodBaseParams(r,e,t,n,!0));let s=0;return e.forEach(((o,l)=>{const{prevTarget:c,hasDelegation:i,isDelegation:u}=prepareEventMethodAdditionalTargetInfo(r,e,l);if(!i){const e=u?EVENT_MAP.get(c):EVENT_MAP.get(o);hasValue(e)&&t.forEach((e=>{const{event:t,namespace:r}=prepareEventMethodEventInfo(e);s+=u?pauseDelegatedHandlers(c,o,r,t,n,a):pauseHandlers(o,r,t,n,null,a)}))}})),s}export function resume(e,t,n=null){return pause(e,t,n,!1)}export function fire(e,t,n=null){const a="fire";({targets:e,events:t}=prepareEventMethodBaseParams(a,e,t,null,!0));let r=0;return e.forEach(((s,o)=>{const{prevTarget:l,hasDelegation:c,isDelegation:i}=prepareEventMethodAdditionalTargetInfo(a,e,o);if(!c){const e=i?EVENT_MAP.get(l):EVENT_MAP.get(s);hasValue(e)&&t.forEach((t=>{const{event:a,namespace:o}=prepareEventMethodEventInfo(t);let c;c=i?gatherTargetEvents(l,o,a,s):gatherTargetEvents(s,o,a),Object.keys(c).forEach((t=>{Array.from(c[t]).forEach((a=>{const o=i?e[t][a].delegations[s]:e[t][a],c=createSyntheticEvent(a,t,n,!1,!1,i?[l,s]:s);o.handlers.forEach((e=>{e.action(c),r++}))}))}))}))}})),r}export function emit(e,t,n=null,a=null,r=null){const s="emit";({targets:e,events:t}=prepareEventMethodBaseParams(s,e,t,null,!0));let o=0;return e.forEach(((l,c)=>{const{prevTarget:i,hasDelegation:u,isDelegation:E}=prepareEventMethodAdditionalTargetInfo(s,e,c);u||t.forEach((e=>{const{event:t,namespace:c}=prepareEventMethodEventInfo(e);assert(hasValue(t),`${MODULE_NAME}:${s} | missing event name`),E?Array.from(i.querySelectorAll(l)).forEach((e=>{e.dispatchEvent(createSyntheticEvent(t,c,n,!0,!0,null,a,r)),o++})):(l.dispatchEvent(createSyntheticEvent(t,c,n,!0,!0,null,a,r)),o++)}))})),o}export function offDetachedElements(e){0===(e=orDefault(e,[],"arr")).length&&(e=Array.from(EVENT_MAP.keys()));let t=0;return e.forEach((e=>{isElement(e)&&!document.body.contains(e)&&EVENT_MAP.has(e)&&(t++,off(e,"*"))})),t}export function onSwipe(e,t,n,a=.2,r=!0,s="annex-swipe"){const o="onSwipe";t=orDefault(t,"","str"),a=orDefault(a,.2,"float"),r=orDefault(r,!0,"bool"),s=orDefault(s,"annex-swipe","str"),assert(SWIPE_DIRECTIONS.includes(t),`${MODULE_NAME}:${o} | unknown direction "${t}"`);let l=[`touchstart.${s}-${t}`,`touchend.${s}-${t}`];r||(l.push(`mousedown.${s}-${t}`),l.push(`mouseup.${s}-${t}`)),({targets:e,events:l,handler:n}=prepareEventMethodBaseParams(o,e,l,n));const c=n;n=r&&"touch"!==detectInteractionType()?()=>{}:c;const i=SWIPE_HANDLERS.get(c)??(e=>{if(updateSwipeTouch(e),["touchend","mouseup"].includes(e.type)){const s=e.currentTarget.offsetWidth,o=e.currentTarget.offsetHeight;r&&"touch"!==detectInteractionType()||!("up"===t&&SWIPE_TOUCH.startY>SWIPE_TOUCH.endY+o*a||"right"===t&&SWIPE_TOUCH.startX<SWIPE_TOUCH.endX-s*a||"down"===t&&SWIPE_TOUCH.startY<SWIPE_TOUCH.endY-o*a||"left"===t&&SWIPE_TOUCH.startX>SWIPE_TOUCH.endX+s*a)||n(e)}});return SWIPE_HANDLERS.set(c,i),on(e,l,i)}export function offSwipe(e,t=null,n=null,a="annex-swipe"){const r="offSwipe";t=orDefault(t,"","str"),a=orDefault(a,"annex-swipe","str"),assert(SWIPE_DIRECTIONS.concat("").includes(t),`${MODULE_NAME}:${r} | unknown direction "${t}"`);let s=0;return(""===t?SWIPE_DIRECTIONS:[t]).forEach((t=>{let o=[`touchstart.${a}-${t}`,`touchend.${a}-${t}`,`mousedown.${a}-${t}`,`mouseup.${a}-${t}`];if(({targets:e,events:o,handler:n}=prepareEventMethodBaseParams(r,e,o,n,!0)),hasValue(n)){const t=SWIPE_HANDLERS.get(n);hasValue(t)&&(s+=off(e,o,t))}else s+=off(e,o)})),s}export function onDomReady(e){if("loading"!==document.readyState)e();else{const t=()=>{document.removeEventListener("DOMContentLoaded",t),e()};document.addEventListener("DOMContentLoaded",t)}}export function onPostMessage(e,t,n,a){const r="onPostMessage";e=resolvePostMessageTarget(e,r),t=orDefault(t,"*","str"),n=`${n}`,assert(isFunction(a),`${MODULE_NAME}:${r} | handler is not a function`),hasValue(POST_MESSAGE_MAP.get(e))||(POST_MESSAGE_MAP.set(e,{}),e.addEventListener("message",windowPostMessageHandler));const s=POST_MESSAGE_MAP.get(e);return hasValue(s[n])||(s[n]=[]),s[n].push({handler:a,origin:t}),()=>{offPostMessage(e,t,n,a)}}export function offPostMessage(e,t=null,n=null,a=null,r=!0){const s="offPostMessage";e=resolvePostMessageTarget(e,s),t=orDefault(t,null,"str"),n=orDefault(n,null,"str"),r=orDefault(r,!0,"bool"),hasValue(a)&&assert(isFunction(a),`${MODULE_NAME}:${s} | handler is not a function`);let o=0;const l=POST_MESSAGE_MAP.get(e);if(hasValue(l)){(hasValue(n)?[n]:Object.keys(l)).forEach((e=>{o+=removePostMessageHandlers(l,e,t,a)})),0===Object.keys(l).length&&POST_MESSAGE_MAP.delete(e)}else r&&(hasValue(a)?e.removeEventListener("message",a):warn(`${MODULE_NAME}:${s} | native fallback event removal for "${n}" not possible, handler is missing`));return hasValue(POST_MESSAGE_MAP.get(e))||e.removeEventListener("message",windowPostMessageHandler),o}export function emitPostMessage(e,t,n,a=null){e=resolvePostMessageTarget(e,"emitPostMessage"),t=orDefault(t,"*","str");const r={type:n=`${n}`};return hasValue(a)&&(r.payload=a),e.postMessage(r,t),e}
//# sourceMappingURL=events.js.map
