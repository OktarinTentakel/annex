/*!
 * @oktarintentakel/annex v0.1.6-beta
 */
/*!
 * Module Requests
 */
const MODULE_NAME="Requests";import{warn}from"./logging.js";import{hasValue,orDefault,isPlainObject,assert,Deferred,getType}from"./basic.js";import{merge}from"./objects.js";import{createNode,insertNode}from"./elements.js";import{schedule,countermand}from"./timers.js";export function createFetchRequest(e,t=null,n=!1){const r="createFetchRequest";return assert(hasValue(e),`Requests:${r} | no url given`),t=orDefault(t,{}),assert(isPlainObject(t),`Requests:${r} | options must be plain object`),t.method=orDefault(t.method,"GET","str"),t.method=["GET","POST","PUT","PATCH","HEAD","OPTIONS","DELETE"].includes(t.method.toUpperCase())?t.method.toUpperCase():"GET",t.timeout=orDefault(t.timeout,1e4,"int"),t.timeout=t.timeout<0?0:t.timeout,n=window.__ANNEX_USE_NATIVE_FETCH__??n,{url:e,options:t,execute:!n||"auto"===n&&!("fetch"in window)?function(){const n=new Deferred,r=new XMLHttpRequest,s=new Set,o=new Map,a=()=>({ok:parseInt(r.status,10)>=200&&parseInt(r.status,10)<=299,statusText:r.statusText,status:r.status,url:r.responseURL,text:()=>Promise.resolve(r.responseText),json:()=>Promise.resolve(r.responseText).then(JSON.parse),blob:()=>Promise.resolve(new Blob([r.response])),clone:a,headers:{keys:()=>s,entries:()=>o,get:e=>o.get(e),has:e=>s.has(e)}});if(r.open(t.method,e,!0),t.timeout>0&&(r.timeout=t.timeout,r.ontimeout=()=>{n.reject(new Error("timeout"))}),r.onload=()=>{r.getAllResponseHeaders().replace(/^(.*?):[^\S\n]*([\s\S]*?)$/gm,((e,t,n)=>{t=`${t}`,s.add(t),o.has(t)?o.set(t,`${o.get(t)},${n}`):o.set(t,`${n}`)})),n.resolve(a())},r.onerror=n.reject,r.withCredentials="include"===t.credentials,hasValue(t.headers))for(let e in t.headers)t.headers.hasOwnProperty(e)&&r.setRequestHeader(e,t.headers[e]);return r.send(t.body??null),n}:function(){const n=new Deferred,r=t.timeout;let s,o;return r>0&&"AbortController"in window&&(o=new AbortController,t.signal=o.signal),window.fetch(e,t).then((e=>{countermand(s),n.resolve(e)})).catch((e=>{countermand(s),n.reject(e)})),r>0&&"AbortController"in window&&(s=schedule(r,(()=>{o.abort()}))),n}}}export function createJsonRequest(e,t=null,n=!1,r=!0){const s="application/json";return r&&(hasValue(t)||(t={}),hasValue(t.headers)||(t.headers={}),t.headers.Accept=s),{url:e,options:t,execute(o="object",a=null,i=null){const l=new Deferred;return createFetchRequest(e,t,n).execute().then((e=>{const t=(e.headers.get("content-type")??e.headers.get("Content-Type")??"").split(";")[0].trim();if(t!==s){const e=`Requests:createJsonRequest | content-type "${t}" is not valid for JSON, expecting "application/json"`;if(r)throw new Error(e);warn(e)}return e.json()})).then((e=>{const t=createNode(`<script type="application/json">${JSON.stringify(e)}<\/script>`);if(null!==i&&t.setAttribute("data-id",`${i}`),hasValue(a)){const e=a.element??a,n=a.position??null;null===n?insertNode(e,t):insertNode(e,t,n)}l.resolve("element"===o?t:"raw"===o?JSON.stringify(e):e)})).catch((e=>{l.reject(e)})),l}}}export function createRestfulJsonClient(e=null,t=null,n=!1,r=!0){!(e=orDefault(e,window.location.origin,"str")).startsWith("//")&&e.startsWith("/")&&(e=`${window.location.origin}${e}`);const s="createRestfulJsonClient",o=createJsonRequest,a="Content-Type";function i(e,t){return t=t.toUpperCase(),assert(["GET","DELETE"].includes(t),`Requests:${s} | invalid request method "${t}"`),e.config.options.method=t,o(e.config.url,e.config.options,n,r).execute().finally((()=>{delete e.config.options.method}))}function l(e,t,i=null){return t=t.toUpperCase(),assert(["POST","PUT","PATCH"].includes(t),`Requests:${s} | invalid request method "${t}"`),hasValue(i)&&assert(isPlainObject(i),`Requests:${s} | data must be plain object`),e.config.options.method=t,e.config.options.body=JSON.stringify(i??e.config.data),e.header(a,"application/json; charset=UTF-8"),o(e.config.url,e.config.options,n,r).execute().finally((()=>{delete e.config.options.method,delete e.config.options.body,e.header(a,null)}))}return{config:{url:new URL("/",e),options:isPlainObject(t)?t:{},params:new URLSearchParams,data:{}},path(t){return this.config.url=new URL(t,e),this},options(e){return hasValue(e)?(assert(isPlainObject(e),`Requests:${s} | options must be plain object`),this.config.options=merge(t,e)):this.config.options=t,this},header(e,t){return hasValue(this.config.options.headers)||(this.config.options.headers={}),hasValue(t)?this.config.options.headers[`${e}`]=`${t}`:delete this.config.options.headers[`${e}`],this},params(e){return hasValue(e)?this.config.params=new URLSearchParams(isPlainObject(e)?function(e){const t=Object.entries(e),n=[];for(const e in t){const r=t[e][0],s=t[e][1],o=getType(s);["array","set"].includes(o)?Array.from(s).forEach((e=>{n.push([r,`${e}`])})):n.push([r,`${s}`])}return n}(e):e):this.config.params=new URLSearchParams,this.config.url.search=this.config.params.toString(),this},data(e){return hasValue(e)?(assert(isPlainObject(e),`Requests:${s} | `),this.config.data=e):this.config.data={},this},get(){return i(this,"GET")},post(e=null){return l(this,"POST",e)},put(e=null){return l(this,"PUT",e)},patch(e=null){return l(this,"PATCH",e)},delete(){return i(this,"DELETE")}}}export function createJsRequest(e,t=null,n=!1,r=!0){const s="application/javascript";return r&&(hasValue(t)||(t={}),hasValue(t.headers)||(t.headers={}),t.headers.Accept=s),{url:e,options:t,execute(o="element",a=null,i=null,l=!1){const c="sourced-element",u=new Deferred,h=(e,t="")=>{if(null!==i&&e.setAttribute("data-id",`${i}`),hasValue(a)){const n=a.element??a,r=a.position??null;l||(e.onload=()=>{u.resolve("raw"===o?t:e)},e.onerror=e=>{u.reject(e)}),null===r?insertNode(n,e):insertNode(n,e,r)}(o!==c||o===c&&l)&&u.resolve("raw"===o?t:e)};return o===c?h(createNode("script",{src:e})):createFetchRequest(e,t,n).execute().then((e=>{const t=(e.headers.get("content-type")??e.headers.get("Content-Type")??"").split(";")[0].trim();if(t!==s){const e=`Requests:createJsRequest | content-type "${t}" is not valid for JavaScript, expecting "application/javascript"`;if(r)throw new Error(e);warn(e)}return e.text()})).then((e=>{h(createNode("script",null,e),e)})).catch((e=>{u.reject(e)})),u}}}export function createCssRequest(e,t=null,n=!1,r=!0){const s="text/css";return r&&(hasValue(t)||(t={}),hasValue(t.headers)||(t.headers={}),t.headers.Accept=s),{url:e,options:t,execute(o="element",a=null,i=null,l="all",c=!1){const u="sourced-element",h=new Deferred,d=(e,t="")=>{if(null!==i&&e.setAttribute("data-id",`${i}`),hasValue(a)){const n=a.element??a,r=a.position??null;c||(e.onload=()=>{h.resolve("raw"===o?t:e)},e.onerror=e=>{h.reject(e)}),null===r?insertNode(n,e):insertNode(n,e,r)}(o!==u||o===u&&c)&&h.resolve("raw"===o?t:e)};if(o===u){const t={href:e,rel:"stylesheet"};"all"!==l&&(t.media=l),d(createNode("link",t))}else createFetchRequest(e,t,n).execute().then((e=>{const t=(e.headers.get("content-type")??e.headers.get("Content-Type")??"").split(";")[0].trim();if(t!==s){const e=`Requests:createCssRequest | content-type "${t}" is not valid for CSS, expecting "text/css"`;if(r)throw new Error(e);warn(e)}return e.text()})).then((e=>{d(createNode("style","all"!==l?{media:l}:null,e),e)})).catch((e=>{h.reject(e)}));return h}}}export function createHtmlRequest(e,t=null,n=!1,r=!0){const s="text/html";return r&&(hasValue(t)||(t={}),hasValue(t.headers)||(t.headers={}),t.headers.Accept=s),{url:e,options:t,execute(o="element",a=null,i=null,l=null,c=!1){const u=new Deferred;return createFetchRequest(e,t,n).execute().then((e=>{const t=(e.headers.get("content-type")??e.headers.get("Content-Type")??"").split(";")[0].trim();if(t!==s){const e=`Requests:createHtmlRequest | content-type "${t}" is not valid for HTML, expecting "text/html"`;if(r)throw new Error(e);warn(e)}return e.text()})).then((e=>{const t=e.includes("<html")||e.includes("<HTML"),n=t||e.includes("<head")||e.includes("<HEAD")||e.includes("<body")||e.includes("<BODY"),r=(new DOMParser).parseFromString(e,"text/html").documentElement;let s;s=hasValue(l)?c?r.querySelectorAll(`${l}`):r.querySelector(`${l}`):t?r:n?r.children:r.querySelector("body").children,hasValue(s?.length)&&(s=0===s.length?null:1===s.length?s.item(0):Array.from(s)),hasValue(l)&&(e="",hasValue(s)&&[].concat(s).forEach((t=>{e+=t.outerHTML}))),((e,t="")=>{if(hasValue(e)){const t=[].concat(e);if(null!==i&&t.forEach((e=>{e.setAttribute("data-id",`${i}`)})),hasValue(a)){const e=a.element??a,n=a.position??null;["before","beforebegin","prepend","afterbegin"].includes(n)&&t.reverse(),t.forEach((t=>{null===n?insertNode(e,t):insertNode(e,t,n)}))}}u.resolve("raw"===o?t:e)})(s,e)})).catch((e=>{u.reject(e)})),u}}}export function visitUrl(e,t=5e3,n=null,r="token"){e=orDefault(e,"","str"),t=Math.abs(orDefault(t,5e3,"int")),n=orDefault(n,null,"str"),r=orDefault(r,"token","str"),e=hasValue(n)?e.replaceAll(`{${r}}`,n):e;const s=new Deferred,o=document.createElement("div");o.innerHTML=`\n\t\t<iframe\n\t\t\tclass="webhook"\n\t\t\tframeborder="0"\n\t\t\tframeborder="0"\n\t\t\tmarginwidth="0"\n\t\t\tmarginheight="0"\n\t\t\tstyle="width:0;height:0;opacity:0;"\n\t\t\tsrc="${e}"\n\t\t></iframe>\n\t`.trim();const a=o.firstChild,i=()=>{a.removeEventListener("load",i),window.clearTimeout(l),window.setTimeout((()=>{document.body.removeChild(a),s.resolve(e)}),250)},l=window.setTimeout((()=>{a.removeEventListener("load",i),document.body.removeChild(a),s.reject(new Error("timeout"))}),t);return a.addEventListener("load",i),document.body.appendChild(a),s}
//# sourceMappingURL=requests.js.map
