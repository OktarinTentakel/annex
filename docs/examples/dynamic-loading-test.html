<!DOCTYPE html>

<html lang="en">
	<head>
		<title>Dynamic Loading Module Examples</title>

		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
		<link rel="apple-touch-icon" sizes="180x180" href="./files/img/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="./files/img/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="./files/img/favicon-16x16.png">

		<link rel="stylesheet" href="./main.css">
		<style type="text/css">

		</style>

		<!-- deprecated version to support ie11 -->
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.5/styles/github.min.css"
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		/>
		<script
			defer
			src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.5/highlight.min.js"
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>

		<script defer src="./lib/handle-version-switching.js"></script>
		<script>
			function setup(
				createFetchRequest,
				polyfillFetch
			){
				var createFetchRequestResultJsonSource = document.querySelector('#create-fetch-request-json-result .source');
				hljs.highlightBlock(createFetchRequestResultJsonSource);

				var
					fBuildRequestJson = function(response){
						return {
							ok : response.ok,
							status : response.status,
							statusText : response.statusText,
							headers : response.headers.entries(),
							payload : {}
						};
					},
					fFetch = function(url, options){
						return createFetchRequest(url, options).execute();
					}
				;

				document.querySelector('#create-fetch-request-1').addEventListener('click', function(e){
					e.preventDefault();

					createFetchRequestResultJsonSource.innerHTML = '';
					var requestJson;

					fFetch('https://jsonplaceholder.typicode.com/posts/1')
						.then(function(response){
							requestJson = fBuildRequestJson(response);
							return response.json();
						})
						.then(function(post){
							requestJson.payload = post;
							createFetchRequestResultJsonSource.innerHTML = JSON.stringify(requestJson, null, 4);
							hljs.highlightBlock(createFetchRequestResultJsonSource);
						})
					;
				});

				document.querySelector('#create-fetch-request-2').addEventListener('click', function(e){
					e.preventDefault();

					createFetchRequestResultJsonSource.innerHTML = '';
					var requestJson;

					fFetch('https://jsonplaceholder.typicode.com/posts', {
						method : 'POST',
						body : JSON.stringify({
							title : 'foo',
							body : 'bar',
							userId : 1,
						}),
						headers: {
							'Content-type' : 'application/json; charset=UTF-8',
						}
					})
						.then(function(response){
							requestJson = fBuildRequestJson(response);
							return response.json();
						})
						.then(function(post){
							requestJson.payload = post;
							createFetchRequestResultJsonSource.innerHTML = JSON.stringify(requestJson, null, 4);
							hljs.highlightBlock(createFetchRequestResultJsonSource);
						})
					;
				});

				document.querySelector('#create-fetch-request-3').addEventListener('click', function(e){
					e.preventDefault();

					createFetchRequestResultJsonSource.innerHTML = '';
					var requestJson;

					fFetch('https://jsonplaceholder.typicode.com/posts/1', {
						method : 'PATCH',
						body : JSON.stringify({
							title : 'foo',
						}),
						headers : {
							'Content-type' : 'application/json; charset=UTF-8',
						}
					})
						.then(function(response){
							requestJson = fBuildRequestJson(response);
							return response.json();
						})
						.then(function(post){
							requestJson.payload = post;
							createFetchRequestResultJsonSource.innerHTML = JSON.stringify(requestJson, null, 4);
							hljs.highlightBlock(createFetchRequestResultJsonSource);
						})
					;
				});

				document.querySelector('#create-fetch-request-4').addEventListener('click', function(e){
					e.preventDefault();

					createFetchRequestResultJsonSource.innerHTML = '';
					var requestJson;

					fFetch('https://jsonplaceholder.typicode.com/posts/1', {
						method : 'DELETE'
					})
						.then(function(response){
							requestJson = fBuildRequestJson(response);
							return response.json();
						})
						.then(function(post){
							requestJson.payload = post;
							createFetchRequestResultJsonSource.innerHTML = JSON.stringify(requestJson, null, 4);
							hljs.highlightBlock(createFetchRequestResultJsonSource);
						})
					;
				});

				document.querySelector('#create-fetch-request-5').addEventListener('click', function(e){
					e.preventDefault();

					createFetchRequestResultJsonSource.innerHTML = '';
					var requestJson;

					fFetch('https://jsonplaceholder.typicode.com/posts/1')
						.then(function(response){
							requestJson = fBuildRequestJson(response);
							return response.text();
						})
						.then(function(post){
							requestJson.payload = post;
							createFetchRequestResultJsonSource.innerHTML = JSON.stringify(requestJson, null, 4);
							hljs.highlightBlock(createFetchRequestResultJsonSource);
						})
					;
				});

				document.querySelector('#create-fetch-request-6').addEventListener('click', function(e){
					e.preventDefault();

					createFetchRequestResultJsonSource.innerHTML = '';
					var requestJson;

					fFetch('./files/img/annex.png', {credentials : 'include'})
						.then(function(response){
							requestJson = fBuildRequestJson(response);
							return response.blob();
						})
						.then(function(image){
							requestJson.payload = image.size;
							createFetchRequestResultJsonSource.innerHTML = JSON.stringify(requestJson, null, 4);
							hljs.highlightBlock(createFetchRequestResultJsonSource);
						})
					;
				});

				document.querySelector('#create-fetch-request-7').addEventListener('click', function(e){
					e.preventDefault();

					createFetchRequestResultJsonSource.innerHTML = '';
					var requestJson;

					fFetch('./files/img/annexx.png')
						.then(function(response){
							requestJson = fBuildRequestJson(response);
							return response.blob();
						})
						.then(function(){
							requestJson.payload = null;
							createFetchRequestResultJsonSource.innerHTML = JSON.stringify(requestJson, null, 4);
							hljs.highlightBlock(createFetchRequestResultJsonSource);
						})
					;
				});



				document.querySelector('#polyfill-fetch-1').addEventListener('click', function(e){
					e.preventDefault();

					polyfillFetch(true);
					fFetch = function(url, options){
						console.log('using polyfilled window.fetch');
						return window.fetch(url, options);
					};
					alert('now using polyfilled window.fetch, reload to reset');
				});
			}
		</script>
		<script type="module">
			if( window.__ANNEX_VERSION__ !== 'es5' ){
				(async () => {
					const {
						createFetchRequest,
						polyfillFetch
					} = await import(`./lib/annex/${window.__ANNEX_VERSION__}/dynamic-loading.js`);

					setup(
						createFetchRequest,
						polyfillFetch
					);
				})().catch(err => {
					console.error(err);
				});
			}
		</script>
		<script defer src="./lib/annex/dist/es5-monolith.js"></script>
		<script defer>
			(function(){
				var annexPoll = window.setInterval(function(){
					if( window.__ANNEX_VERSION__ && window.annex ){
						window.clearInterval(annexPoll);

						if( window.__ANNEX_VERSION__ === 'es5' ){
							setup(
								window.annex.dynamicLoading.createFetchRequest,
								window.annex.dynamicLoading.polyfillFetch
							);
						}
					}
				}, 250);
			})();
		</script>
	</head>

	<body>
		<header>
			<h1>Dynamic Loading Module Examples</h1>
		</header>
		<main>
			<h3>createFetchRequest</h3>
			<section>
				<p>
					Trigger a request below, to see the response information.
					(the last two image requests might fail if you are viewing this file directly from the
					file system, due to CORS security settings, but the examples should work when served by
					a webserver)
				</p>
				<div>
					<pre id="create-fetch-request-json-result"><code class="source language-json"></code></pre>
					<a id="create-fetch-request-1">Should query a JSON API and return a post in the payload</a>
					<a id="create-fetch-request-2">Should query a JSON API and return a newly created post with title "foo" and body "bar" in the payload</a>
					<a id="create-fetch-request-3">Should query a JSON API and return a patched post with title "foo" in the payload</a>
					<a id="create-fetch-request-4">Should query a JSON API and delete a post, which should result in an empty payload</a>
					<a id="create-fetch-request-5">Should query a JSON API and return a post as unformatted text in the payload</a>
					<a id="create-fetch-request-6">Should query a local image and return its size in the payload</a>
					<a id="create-fetch-request-7">Should query a missing local image and return an error response with a null payload</a>
				</div>
			</section>

			<h3>polyfillFetch</h3>
			<section>
				<p>
					Click the button to force polyfill window.fetch with annex' solution.
					After that, the links above use window.fetch, which should then be our solution again.
				</p>
				<div>
					<button id="polyfill-fetch-1" class="btn light-blue darken-1">Force polyfill window.fetch</button>
				</div>
			</section>
		</main>
	</body>
</html>
