/*!
 * @oktarintentakel/annex v0.1.4-beta
 */
/*!
 * Module Requests
 */
const MODULE_NAME="Requests";import{warn}from"./logging.js";import{hasValue,orDefault,isPlainObject,assert,Deferred}from"./basic.js";import{createNode,insertNode}from"./elements.js";import{schedule,countermand}from"./timers.js";export function createFetchRequest(e,t=null,n=!1){const r="createFetchRequest";return assert(hasValue(e),`Requests:${r} | no url given`),t=orDefault(t,{}),assert(isPlainObject(t),`Requests:${r} | options must be plain object`),t.method=orDefault(t.method,"GET","str"),t.method=["GET","POST","PUT","PATCH","HEAD","OPTIONS","DELETE"].includes(t.method.toUpperCase())?t.method.toUpperCase():"GET",t.timeout=orDefault(t.timeout,1e4,"int"),t.timeout=t.timeout<0?0:t.timeout,{url:e,options:t,execute:!n||"auto"===n&&!("fetch"in window)?function(){const n=new Deferred,r=new XMLHttpRequest,o=new Set,s=new Map,l=()=>({ok:parseInt(r.status,10)>=200&&parseInt(r.status,10)<=299,statusText:r.statusText,status:r.status,url:r.responseURL,text:()=>Promise.resolve(r.responseText),json:()=>Promise.resolve(r.responseText).then(JSON.parse),blob:()=>Promise.resolve(new Blob([r.response])),clone:l,headers:{keys:()=>o,entries:()=>s,get:e=>s.get(e),has:e=>o.has(e)}});if(r.open(t.method,e,!0),t.timeout>0&&(r.timeout=t.timeout,r.ontimeout=()=>{n.reject(new Error("timeout"))}),r.onload=()=>{r.getAllResponseHeaders().replace(/^(.*?):[^\S\n]*([\s\S]*?)$/gm,((e,t,n)=>{t=`${t}`,o.add(t),s.has(t)?s.set(t,`${s.get(t)},${n}`):s.set(t,`${n}`)})),n.resolve(l())},r.onerror=n.reject,r.withCredentials="include"===t.credentials,hasValue(t.headers))for(let e in t.headers)t.headers.hasOwnProperty(e)&&r.setRequestHeader(e,t.headers[e]);return r.send(t.body??null),n}:function(){const n=new Deferred,r=t.timeout;let o,s;return r>0&&"AbortController"in window&&(s=new AbortController,t.signal=s.signal),window.fetch(e,t).then((e=>{countermand(o),n.resolve(e)})).catch((e=>{countermand(o),n.reject(e)})),r>0&&"AbortController"in window&&(o=schedule(r,(()=>{s.abort()}))),n}}}export function createJsonRequest(e,t=null,n=!1){return{url:e,options:t,execute(r="object",o=null,s=null){const l=new Deferred;return createFetchRequest(e,t,n).execute().then((e=>{const t=(e.headers.get("content-type")??e.headers.get("Content-Type")??"").split(";")[0].trim();return"application/json"!==t&&warn(`Requests:createJsonRequest | content-type "${t}" is not valid for JSON, use "application/json"`),e.json()})).then((e=>{const t=createNode(`<script type="application/json">${JSON.stringify(e)}<\/script>`);if(null!==s&&t.setAttribute("data-id",`${s}`),hasValue(o)){const e=o.element??o,n=o.position??null;null===n?insertNode(e,t):insertNode(e,t,n)}l.resolve("element"===r?t:"raw"===r?JSON.stringify(e):e)})).catch((e=>{l.reject(e)})),l}}}export function createJsRequest(e,t=null,n=!1){return{url:e,options:t,execute(r="element",o=null,s=null,l=!1){const a="sourced-element",i=new Deferred,u=(e,t="")=>{if(null!==s&&e.setAttribute("data-id",`${s}`),hasValue(o)){const n=o.element??o,s=o.position??null;l||(e.onload=()=>{i.resolve("raw"===r?t:e)},e.onerror=e=>{i.reject(e)}),null===s?insertNode(n,e):insertNode(n,e,s)}(r!==a||r===a&&l)&&i.resolve("raw"===r?t:e)};return r===a?u(createNode("script",{src:e})):createFetchRequest(e,t,n).execute().then((e=>{const t=(e.headers.get("content-type")??e.headers.get("Content-Type")??"").split(";")[0].trim();return"application/javascript"!==t&&warn(`Requests:createJsRequest | content-type "${t}" is not valid for JavaScript, use "application/javascript"`),e.text()})).then((e=>{u(createNode("script",null,e),e)})).catch((e=>{i.reject(e)})),i}}}export function createCssRequest(e,t=null,n=!1){return{url:e,options:t,execute(r="element",o=null,s=null,l="all",a=!1){const i="sourced-element",u=new Deferred,c=(e,t="")=>{if(null!==s&&e.setAttribute("data-id",`${s}`),hasValue(o)){const n=o.element??o,s=o.position??null;a||(e.onload=()=>{u.resolve("raw"===r?t:e)},e.onerror=e=>{u.reject(e)}),null===s?insertNode(n,e):insertNode(n,e,s)}(r!==i||r===i&&a)&&u.resolve("raw"===r?t:e)};if(r===i){const t={href:e,rel:"stylesheet"};"all"!==l&&(t.media=l),c(createNode("link",t))}else createFetchRequest(e,t,n).execute().then((e=>{const t=(e.headers.get("content-type")??e.headers.get("Content-Type")??"").split(";")[0].trim();return"text/css"!==t&&warn(`Requests:createCssRequest | content-type "${t}" is not valid for CSS, use "text/css"`),e.text()})).then((e=>{c(createNode("style","all"!==l?{media:l}:null,e),e)})).catch((e=>{u.reject(e)}));return u}}}export function createHtmlRequest(e,t=null,n=!1){return{url:e,options:t,execute(r="element",o=null,s=null,l=null,a=!1){const i=new Deferred;return createFetchRequest(e,t,n).execute().then((e=>{const t=(e.headers.get("content-type")??e.headers.get("Content-Type")??"").split(";")[0].trim();return"text/html"!==t&&warn(`Requests:createHtmlRequest | content-type "${t}" is not valid for HTML, use "text/html"`),e.text()})).then((e=>{const t=e.includes("<html")||e.includes("<HTML"),n=t||e.includes("<head")||e.includes("<HEAD")||e.includes("<body")||e.includes("<BODY"),u=(new DOMParser).parseFromString(e,"text/html").documentElement;let c;c=hasValue(l)?a?u.querySelectorAll(`${l}`):u.querySelector(`${l}`):t?u:n?u.children:u.querySelector("body").children,hasValue(c?.length)&&(c=0===c.length?null:1===c.length?c.item(0):Array.from(c)),hasValue(l)&&(e="",hasValue(c)&&[].concat(c).forEach((t=>{e+=t.outerHTML}))),((e,t="")=>{if(hasValue(e)){const t=[].concat(e);if(null!==s&&t.forEach((e=>{e.setAttribute("data-id",`${s}`)})),hasValue(o)){const e=o.element??o,n=o.position??null;["before","beforebegin","prepend","afterbegin"].includes(n)&&t.reverse(),t.forEach((t=>{null===n?insertNode(e,t):insertNode(e,t,n)}))}}i.resolve("raw"===r?t:e)})(c,e)})).catch((e=>{i.reject(e)})),i}}}export function visitUrl(e,t=5e3,n=null,r="token"){e=orDefault(e,"","str"),t=Math.abs(orDefault(t,5e3,"int")),n=orDefault(n,null,"str"),r=orDefault(r,"token","str"),e=hasValue(n)?e.replaceAll(`{${r}}`,n):e;const o=new Deferred,s=document.createElement("div");s.innerHTML=`\n\t\t<iframe\n\t\t\tclass="webhook"\n\t\t\tframeborder="0"\n\t\t\tframeborder="0"\n\t\t\tmarginwidth="0"\n\t\t\tmarginheight="0"\n\t\t\tstyle="width:0;height:0;opacity:0;"\n\t\t\tsrc="${e}"\n\t\t></iframe>\n\t`.trim();const l=s.firstChild,a=()=>{l.removeEventListener("load",a),window.clearTimeout(i),window.setTimeout((()=>{document.body.removeChild(l),o.resolve(e)}),250)},i=window.setTimeout((()=>{l.removeEventListener("load",a),document.body.removeChild(l),o.reject(new Error("timeout"))}),t);return l.addEventListener("load",a),document.body.appendChild(l),o}
//# sourceMappingURL=requests.js.map
